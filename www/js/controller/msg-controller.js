var insert_chat=0;angular.module("myapp").controller("msgController",function(t){t.datas=1,t.base_url=base_url,t.user_id=localStorage.getItem("user_id"),null==socket&&init(t.user_id)}).directive("msgarchiveDir",function(t){return{link:function(e){function s(){$(".follower").next(".loading_users").show(),$(".follower").next(".refresh_loading").hide(),0==r&&(r=1,$.get(base_url+"/api_chat/chat_list/A3deWW-00353SSS-CHat/"+localStorage.getItem("user_id")+"/"+i+"/"+n,function(s){r=0,data=new Object,data=JSON.parse(s),console.log(data),$(".follower").next(".loading_users").hide(),$("body .lpro").addClass("none"),data.length>0?(data.forEach(function(t,e){new Date(t.date);t.dates=moment(t.date).calendar(),a.push(t)}),e.$apply(function(){e.datas=a,t.msg=a,t.msg_ofset=i}),i+=20,is_req=0):0==i&&($(".one_ids").next(".refresh_loading").show(),e.$apply(function(){e.datas=void 0}))}).fail(function(){$(".one_ids").next(".refresh_loading").show()}))}var o=new Snap({element:document.getElementById("content20"),disable:"left"});$("body #content20").on("click","#open-right",function(){"right"==o.state().state?o.close():o.open("right")}),"msg_detail"!=now_h&&(t.msg=void 0,t.msg_ofset=void 0);var i=0,n=0,a=Array(),r=0,l=moment().subtract(24,"hour").valueOf();console.log(l),void 0!==t.msg?(e.datas=t.msg,i=t.msg_ofset,console.log(t.msg)):s(),$("#content20 .of_list").on("scroll",function(){var e=$("#content20 .of_list"),o=e.scrollTop()-e.height()+$(window).height(),i=$("#content20 .follower").height();console.log(i-o),600>i-o&&0==is_req&&(is_req=1,s(t.search_data,t.search_address))}),$(".user_list").on("click",".chat_remove",function(){var s=$(this).attr("msg_chat_id");if(1==confirm("آیا برای حذف اطمینان دارید")){$.get(base_url+"/api_upload/disable_all_msg/UPssdfo-098UdfsdfY-oosfWu/"+localStorage.getItem("user_id")+"/"+$(this).attr("your_id"),function(t){});var o=$.grep(e.datas,function(t){return t.msg_chat_id!=s});return console.log(o),e.$apply(function(){t.msg=o,e.datas=o}),!1}}),$(".chat_view").delegate(".chat_one","click",function(){localStorage.removeItem("chat"),t.chat=Array({name:$(this).find("h3").text(),member_id:$(this).find("h3").attr("your_id"),gender:$(this).find("h3").attr("user_gender"),picname:$(this).find("h3").attr("user_image"),msg_chat_id:$(this).attr("msg_chat_id")}),localStorage.setItem("chat",JSON.stringify(t.chat)),window.location.href="#/msg_detail"}),$(".contanet_profile").on("click",".refresh_msg",function(){i=0,n=0,e.$apply(function(){a=[]}),s()});var c=document.getElementById("home_btn_ref");console.log(c),c.addEventListener("touchmove",function(t){var e=t.targetTouches[0];c.style.left=e.pageX-25+"px",c.style.top=e.pageY-25+"px",t.preventDefault()},!1)}}}).controller("msgdetailController",function(t,e){null==socket&&init(t.user_id),t.user_id=localStorage.getItem("user_id"),t.base_url=base_url,void 0!==e.chat?t.user_info=e.chat:void 0===e.chat&&void 0!==localStorage.getItem("chat")&&(t.chat=JSON.parse(localStorage.getItem("chat")),t.user_info=t.chat)}).directive("msgdetailDir",function(t){return{link:function(e){ofset_msg=0,is_req=0,you=e.chat[0].member_id,me=e.user_id,setInterval(function(){socket||send(me,you,"havij","blabla")},5e3),console.log(you,me),fetch_msg_websocket(e.user_id,e.user_info[0].member_id,""),$(".msg_submit").submit(function(){var s=($(".msg_submit").serialize(),$(".msg_text").val());return s=s.replace(/(<([^>]+)>)/gi,""),txt2=s.replace(/(?:\r\n|\r|\n)/g,"<br />"),""==$(".msg_text").val().trim()?($(".msg_text").val("").focus(),!1):(send(me,you,"send",s),t.msg&&t.msg.forEach(function(t,o){(t.msg_me_id==e.user_info[0].member_id||t.msg_you_id==e.user_info[0].member_id)&&(t.msg_txt=s,t.date=data.date)}),insert_chat++,void $(".msg_text").val("").focus())}),$(".msg_list_chat").on("scroll",function(){0==$(".msg_list_chat").scrollTop()&&0==is_req&&(is_req=1,fetch_msg_websocket(e.user_id,e.user_info[0].member_id,$(".msg_one:eq(0)").attr("id")))}),$(".icons").on("click",".delete_chat",function(){var e=$(this).attr("msg_chat_id");1==confirm("آیا برای حذف اطمینان دارید")&&$.get(base_url+"/api_upload/disable_all_msg/UPssdfo-098UdfsdfY-oosfWu/"+localStorage.getItem("user_id")+"/"+$(this).attr("your_id"),function(s){if(void 0!==t.msg){var o=$.grep(t.msg,function(t){return t.msg_chat_id!=e});0==o.length?t.msg=void 0:t.msg=o}return window.location.hash="#/msg",!1})}),$(".icons").on("click",".delete_block_chat",function(){var e=$(this).attr("msg_chat_id");console.log(e);1==confirm("آیا برای حذف و بلاک این کاربر اطمینان دارید اطمینان دارید")&&$.get(base_url+"/api_upload/disable_remove_all_msg/UPssdfo-098sc33UdfsdfY-oosfWu/"+localStorage.getItem("user_id")+"/"+$(this).attr("your_id"),function(){if(void 0!==t.msg){var s=$.grep(t.msg,function(t){return t.msg_chat_id!=e});0==s.length?t.msg=void 0:t.msg=s}return window.location.hash="#/msg",!1})}),$(".msg_text").on("focus",function(){$(window).resize(function(){$(".msg_list_chat").scrollTop($(".msg_list_chat")[0].scrollHeight),$(".editor").css("height","19%"),$(".msg_list_chat").css("height","80%")})}),$(".msg_text").on("blur",function(){$(window).resize(function(){$(".editor").css("height","12%"),$(".msg_list_chat").css("height","90%"),$(".msg_list_chat").scrollTop($(".msg_list_chat")[0].scrollHeight)})}),window_height=$(window).height(),$(window).resize(function(){setTimeout(function(){$(window).height()<window_height?($(".msg_list_chat").scrollTop($(".msg_list_chat")[0].scrollHeight),$(".editor").css("height","19%"),$(".msg_list_chat").css("height","80%")):($(".editor").css("height","12%"),$(".msg_list_chat").css("height","90%"),$(".msg_list_chat").scrollTop($(".msg_list_chat")[0].scrollHeight))},1e3)})}}});